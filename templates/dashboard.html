{% extends "base.html" %}
{% block content %}

<!-- TOP BAR -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0">Dashboard</h4>

  <!-- LOGOUT BUTTON -->
  <a href="/logout"
     class="btn btn-sm btn-danger">
     Logout
  </a>
</div>

<!-- KPI CARDS -->
<div class="row g-3">
  <div class="col-md-3">
    <div class="card p-3">
      <div class="text-muted">Today's Sales</div>
      <div class="fs-3 fw-bold">
        ‚Çπ {{ '%.2f'|format(kp.today_sales) }}
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card p-3">
      <div class="text-muted">Pending Devices</div>
      <div class="fs-3 fw-bold">
        {{ kp.pending }}
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card p-3">
      <div class="text-muted">Overdue (&gt;10 days)</div>
      <div class="fs-3 fw-bold text-danger">
        {{ kp.overdue }}
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card p-3">
      <div class="text-muted">Ledger Balance (Net)</div>
      <div class="fs-3 fw-bold">
        ‚Çπ {{ '%.2f'|format(kp.ledger_bal) }}
      </div>
    </div>
  </div>
</div>

<!-- QUICK ACTIONS -->
<div class="card mt-3 p-3">
  <h5 class="mb-2">Quick Actions</h5>

  <div class="d-flex flex-wrap gap-2">

    <!-- COMMON FOR ADMIN + STAFF -->
    <a href="/service" class="btn btn-primary">
      New Service Entry
    </a>

    <!-- ADMIN ONLY BUTTONS -->
    {% if session.role == 'admin' %}
      <a href="/sales" class="btn btn-success">
        Add Sale
      </a>
      <a href="/ledger" class="btn btn-secondary">
     Ledger Entry
     </a>
      <a href="/customers" class="btn btn-info">
        Add Customer
      </a>
      <a href="/overdue" class="btn btn-warning">
        View Overdue
      </a>
<a href="/ink" class="ink-btn">INK STOCK MANAGEMENT</a>
<style>
.ink-btn{
  display:block;
  margin-top:15px;
  padding:18px;
  text-align:center;
  font-size:18px;
  font-weight:700;
  color:#fff;
  background:linear-gradient(135deg,#6366f1,#22c55e);
  border-radius:12px;
  text-decoration:none;
  box-shadow:0 0 0 rgba(99,102,241,0.6);
  animation:pulse 1.5s infinite;
}

@keyframes pulse{
  0%{box-shadow:0 0 0 0 rgba(99,102,241,.6)}
  70%{box-shadow:0 0 0 15px rgba(99,102,241,0)}
  100%{box-shadow:0 0 0 0 rgba(99,102,241,0)}
}
</style>
<a href="/export/entries" class="btn btn-primary d-flex align-items-center gap-2">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
         fill="currentColor" viewBox="0 0 16 16">
        <path d="M5.884 6.68a.5.5 0 0 1 .707 0L8 8.086l1.409-1.406a.5.5 0 1 1 .707.707l-1.766 1.767a.5.5 0 0 1-.707 0L5.884 7.387a.5.5 0 0 1 0-.707z"/>
        <path d="M8 1.5a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V2a.5.5 0 0 1 .5-.5z"/>
        <path d="M14 10.5a.5.5 0 0 1 .5.5v2A1.5 1.5 0 0 1 13 14.5H3A1.5 1.5 0 0 1 1.5 13v-2a.5.5 0 0 1 1 0v2A.5.5 0 0 0 3 13.5h10a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 .5-.5z"/>
    </svg>
    Export Data
</a>
    {% endif %}

  </div>
</div>

<!-- INK STOCK OVERVIEW -->
<div class="card mt-4 p-3">
  <h5 class="mb-3">Ink Stock Overview</h5>

  <div id="inkGrid" class="row g-3"></div>
</div>
<!-- ‚ö†Ô∏è LIVE WARNING BANNER -->

<div class="warning-wrap">
  <div class="warning-track" id="warningText">
    ‚ö†Ô∏è Loading warnings...
  </div>
</div>

<style>
.warning-wrap{
  width:100%;
  overflow:hidden;
  background:#1d4ed8; /* BLUE */
  border-radius:10px;
  margin-top:12px;
  padding:10px 0;
}

.warning-track{
  display:inline-block;
  white-space:nowrap;
  color:#dc2626; /* RED TEXT */
  font-size:15px;
  font-weight:700;
  padding-left:100%;
  animation: warningScroll 30s linear infinite;
}

@keyframes warningScroll{
  0%{
    transform: translateX(0);
  }
  100%{
    transform: translateX(-100%);
  }
}
</style>

<script>
async function loadWarnings(){
  let msgs = [];

  // üîß SERVICE WARNINGS
  const entries = await fetch("/api/entries").then(r=>r.json());

  entries.forEach(e=>{
    if(e.status === "Out"){
      msgs.push(`‚ö†Ô∏è ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ${e.customer} ‡§ï‡§æ ${e.type} (${e.model}) ‡§Ö‡§≠‡•Ä ‡§§‡§ï ‡§¶‡•Å‡§ï‡§æ‡§® ‡§Æ‡•á‡§Ç ‡§®‡§π‡•Ä‡§Ç ‡§Ü‡§Ø‡§æ ‡§π‡•à`);
    }
    if(e.status === "Ready"){
      msgs.push(`‚ö†Ô∏è ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ${e.customer} ‡§ï‡§æ ${e.type} (${e.model}) ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•à ‡§≤‡•á‡§ï‡§ø‡§® ‡§Ö‡§≠‡•Ä ‡§§‡§ï ‡§≤‡•á ‡§ó‡§Ø‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à`);
    }
  });

  // üñ®Ô∏è INK WARNINGS
  const inks = await fetch("/api/ink").then(r=>r.json());
  inks.forEach(i=>{
    if(i.qty === 0){
      msgs.push(`üñ®Ô∏è ‡§á‡§Ç‡§ï ${i.model} ‡§™‡•Ç‡§∞‡•Ä ‡§§‡§∞‡§π ‡§ñ‡§§‡•ç‡§Æ ‡§π‡•ã ‡§ö‡•Å‡§ï‡§æ ‡§π‡•à`);
    }
  });

  document.getElementById("warningText").innerText =
    msgs.length ? msgs.join("   üîπ   ") : "‚úÖ ‡§Ö‡§≠‡•Ä ‡§ï‡•ã‡§à ‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à";
}

loadWarnings();
</script>


   
<style>
.ink-box{
  border-radius:12px;
  padding:16px;
  color:#fff;
  font-weight:600;
  text-align:center;
}
.ink-red{background:#dc2626;}
.ink-orange{background:#f97316;}
.ink-green{background:#16a34a;}

.blink{
  animation:blink 1s infinite;
}
@keyframes blink{
  0%{opacity:1}
  50%{opacity:.4}
  100%{opacity:1}
}
</style>

<script>
async function loadInkDashboard(){
  const res = await fetch("/api/ink");
  const data = await res.json();

  let html = "";

  data.forEach(i=>{
    let cls = "ink-green";
    let blink = "";

    if(i.qty === 0){
      cls = "ink-red";
      blink = "blink";
    }
    else if(i.qty <= 5){
      cls = "ink-red";
    }
    else if(i.qty <= 9){
      cls = "ink-orange";
    }

    html += `
      <div class="col-6 col-md-3">
        <div class="ink-box ${cls} ${blink}">
          ${i.model}<br>
          Qty: ${i.qty}
        </div>
      </div>
    `;
  });

  document.getElementById("inkGrid").innerHTML = html;
}

loadInkDashboard();
</script>

{% endblock %}