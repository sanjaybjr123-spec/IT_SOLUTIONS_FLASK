{% extends "base.html" %}
{% block content %}

<div class="card p-3">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h4 class="mb-0">New Device Entry</h4>
      <small>GHATSILA COLLEGE ROAD</small>
    </div>
    <div class="d-flex gap-2">
      <input id="searchBox" class="form-control form-control-sm" placeholder="ðŸ” Search...">
      <a href="/overdue" class="btn btn-warning btn-sm">Overdue List</a>
      <button id="refreshBtn" class="btn btn-outline-secondary btn-sm">Refresh</button>
    </div>
  </div>
  <hr>

  <div class="row g-2">
    <div class="col-md-3">
      <label class="form-label">Type</label>
      <select id="type" class="form-select">
        <option>Laptop</option>
        <option>Printer</option>
        <option>Other</option>
      </select>
    </div>
    <div class="col-md-3"><label class="form-label">Customer</label><input id="customer" class="form-control"></div>
    <div class="col-md-3"><label class="form-label">Phone</label><input id="phone" class="form-control"></div>
    <div class="col-md-3"><label class="form-label">Model / Serial</label><input id="model" class="form-control"></div>
    <div class="col-12"><label class="form-label">Problem</label><textarea id="problem" class="form-control"></textarea></div>
    <div class="col-md-4"><label class="form-label">Receive Date</label><input id="receive_date" class="form-control" disabled></div>
    <div class="col-md-2 d-flex align-items-end">
      <button id="saveBtn" class="btn btn-primary w-100">Save</button>
    </div>
  </div>
</div>

<div class="card p-3 mt-3">
  <h5>Device List</h5>
  <div class="table-responsive">
    <table class="table table-sm" id="tbl">
      <thead class="table-primary">
        <tr>
          <th>#</th><th>Type</th><th>Customer</th><th>Phone</th><th>Model</th>
          <th>Problem</th><th>Receive</th><th>Out</th><th>In</th>
          <th>Delivered</th><th>Status</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const recv=document.getElementById('receive_date');
recv.value=new Date().toLocaleString();

document.getElementById('saveBtn').onclick=async()=>{
  const d={
    type:type.value,
    customer:customer.value,
    phone:phone.value,
    model:model.value,
    problem:problem.value,
    amount:0
  };
  await fetch('/api/entries',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(d)
  });
  load();
};

async function load(){
  const r=await fetch('/api/entries');
  const rows=await r.json();
  render(rows);
}

function render(rows){
  const tb=document.querySelector('#tbl tbody');
  tb.innerHTML='';
  rows.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${r.type||''}</td>
      <td>${r.customer||''}</td>
      <td>${r.phone||''}</td>
      <td>${r.model||''}</td>
      <td>${r.problem||''}</td>
      <td>${r.receive_date||''}</td>
      <td>${r.out_date||''}</td>
      <td>${r.in_date||''}</td>
      <td>${r.delivered_date||''}</td>
      <td><span class="badge bg-info">${r.status||''}</span></td>
      <td class="text-nowrap">
        <button onclick="act(${r.id},'out')">Out</button>
        <button onclick="act(${r.id},'in')">In</button>
        <button onclick="act(${r.id},'ready')">Ready</button>
        <button onclick="act(${r.id},'delivered')">Delivered</button>
        <button onclick="act(${r.id},'reject')">Reject</button>
        <button onclick="setAmount(${r.id})">Bill</button>
        <button onclick="window.open('/print/${r.id}')">Print</button>
        <button onclick="delE(${r.id})">Delete</button>
      </td>`;
    tb.appendChild(tr);
  });
}

async function act(id,action){
  await fetch(`/api/entries/${id}/action`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({action})
  });
  load();
}

async function delE(id){
  if(confirm('Delete?')){
    await fetch(`/api/entries/${id}`,{method:'DELETE'});
    load();
  }
}

async function setAmount(id){
  const amt=prompt("Enter final amount:");
  if(!amt) return;
  await fetch(`/api/entries/${id}/amount`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({amount:amt})
  });
  load();
}

load();
</script>

{% endblock %}